<template id="task-detail-drawer">
  <v-navigation-drawer v-model="isDrawerShown" :permanent="isDrawerShown" fixed temporary right width="80%"
    class="elevation-24">
    <!--抽屉标题-->
    <v-row class="justify-space-between align-center pa-4" no-gutters>
      <span class="text-h7 font-weight-bold">任务详情</span>
      <div>
        <v-menu offset-y>
          <template v-slot:activator="{ on, attrs }">
            <v-btn small v-bind="attrs" v-on="on">
              <v-icon size="16">mdi-dots-horizontal</v-icon>
            </v-btn>
          </template>
          <v-list>
            <v-list-item @click="doUiAction('deleteTask')">
              <v-list-item-title>删除</v-list-item-title>
            </v-list-item>
          </v-list>
        </v-menu>
      </div>
    </v-row>
    <v-divider class="jh-divider"></v-divider>

    <v-progress-linear v-if="isLoading" indeterminate color="primary"></v-progress-linear>

    <v-form v-model="isFormValid" v-else ref="editForm" lazy-validation>

      <!--抽屉表单-->
      <v-row class="ma-0">

        <v-col cols="12" sm="12" md="4" xl="3">
          <span class="inputLabel"><span class="red--text">*</span>任务名称</span>
          <v-text-field :rules="requireRules" class="jh-v-input " dense filled single-line
            v-model="detail.taskTitle"></v-text-field>
        </v-col>

        <v-col cols="12" sm="12" md="12" xl="12">
          <span class="inputLabel">任务内容</span>
          <v-textarea class="jh-v-input " dense filled single-line v-model="detail.taskContent"></v-textarea>
        </v-col>

        <v-col cols="12" sm="12" md="4" xl="3">
          <span class="inputLabel">开始时间</span>
          <v-menu v-model="isStartAtMenuShown" :close-on-content-click="false" :nudge-right="40"
            transition="scale-transition" offset-y min-width="auto">
            <template v-slot:activator="{ on, attrs }">
              <v-text-field append-icon="mdi-calendar" class="jh-v-input" dense single-line filled
                v-model="detail.taskStartAt" v-bind="attrs" v-on="on"></v-text-field>
            </template>
            <v-date-picker v-model="detail.taskStartAt" no-title scrollable></v-date-picker>
          </v-menu>
        </v-col>

        <v-col cols="12" sm="12" md="4" xl="3">
          <span class="inputLabel">结束时间</span>
          <v-menu v-model="isEndAtMenuShown" :close-on-content-click="false" :nudge-right="40"
            transition="scale-transition" offset-y min-width="auto">
            <template v-slot:activator="{ on, attrs }">
              <v-text-field append-icon="mdi-calendar" class="jh-v-input" dense single-line filled
                v-model="detail.taskEndAt" v-bind="attrs" v-on="on"></v-text-field>
            </template>
            <v-date-picker v-model="detail.taskEndAt" no-title scrollable></v-date-picker>
          </v-menu>
        </v-col>

        <v-col cols="12" sm="12" md="4" xl="3">
          <span class="inputLabel">优先级</span>
          <v-autocomplete :items="constantObj.taskLevel" class="jh-v-input" dense single-line filled
            v-model="detail.taskLevel"></v-autocomplete>
        </v-col>

        <v-col cols="12" sm="12" md="4" xl="3">
          <span class="inputLabel">处理人</span>
          <v-autocomplete :items="userList" class="jh-v-input" item-text="username" item-value="userId" dense
            single-line filled v-model="detail.taskManagerId"></v-autocomplete>
        </v-col>

        <v-col cols="12" sm="12" md="4" xl="3">
          <span class="inputLabel">团队成员</span>
          <v-autocomplete multiple :items="userList" class="jh-v-input" item-text="username" item-value="userId" dense
            single-line filled v-model="detail.taskMemberIdList"></v-autocomplete>
        </v-col>

        <v-col cols="12" sm="12" md="4" xl="3">
          <span class="inputLabel">状态</span>
          <v-autocomplete :items="constantObj.taskStatus" class="jh-v-input" dense single-line filled
            v-model="detail.taskStatus"></v-autocomplete>
        </v-col>

      </v-row>
      <!--抽屉操作按钮-->
      <v-row class="mx-0 justify-end mt-4">
        <v-btn color="success" @click="doUiAction('updateTask')" small>保存</v-btn>
        <v-btn class="elevation-0 ml-2" @click="isDrawerShown = false" small>取消</v-btn>
      </v-row>
    </v-form>
    <!--抽屉关闭按钮-->
    <v-btn elevation="0" color="success" fab absolute top left small tile class="drawer-close-float-btn"
      @click="isDrawerShown = false">
      <v-icon>mdi-close</v-icon>
    </v-btn>
  </v-navigation-drawer>
</template>

<script type="module">
  Vue.component("task-detail-drawer", {
    template: '#task-detail-drawer',
    props: {
      userList: {
        type: 'array',
        default: []
      }
    },
    data: () => ({
      isDrawerShown: false,
      detail: {},
      isLoading: false,

      isFormValid: true,
      requireRules: [
        v => !!v || '必填',
      ],

      isStartAtMenuShown: false,
      isEndAtMenuShown: false,

    }),
    created() {
    },
    methods: {
      async doUiAction(uiActionId, uiActionData) {
        switch (uiActionId) {
          case 'open':
            await this.open(uiActionData);
            await this.getTaskDetail();
            break;
          case 'updateTask':
            await this.confirmUpdateItemDialog();
            await this.updateTask(uiActionData);
            await this.close();
            break;
          case 'deleteTask':
            await this.confirmDeleteItemDialog();
            await this.deleteTask(uiActionData);
            await this.close();
            break;
          default:
            console.error("[doUiAction] uiActionId not find", { uiActionId });
            break;
        }
      },
      async open({ taskId }) {
        this.isDrawerShown = true;
        this.taskId = taskId;
      },
      async getTaskDetail() {
        this.isLoading = true;
        const rows = (await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'allPage',
              actionId: 'getTaskList',
              actionData: {},
              where: { taskId: this.taskId },
            }
          }
        })).data.appData.resultData.rows;
        this.isLoading = false;
        rows.forEach(row=> {
          row.taskMemberIdList = row.taskMemberIdList.split(',')
        })

        this.detail = rows[0] || {}
      },
      // ---------- 更新task >>>>>>>>>>>>> ----------
      async confirmUpdateItemDialog() {
        if (await window.confirmDialog({ title: "修改", content: "确定修改吗？" }) === false) {
          throw new Error("取消");
        }
      },
      async updateTask() {
        await window.jhMask.show();
        await window.vtoast.loading("更新数据");

        const { id, ...data } = this.detail
        if (data.taskMemberIdList.length === 0) {
          data.taskMemberIdList = [data.taskManagerId]
        }
        data.taskMemberIdList = data.taskMemberIdList.join(',')

        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'allPage',
              actionId: 'updateTask',
              actionData: data,
              where: { id },
            }
          }
        })
        await window.jhMask.hide();
        await window.vtoast.success("更新数据成功");
        this.$emit('save')
      },
      async close() {
        this.isDrawerShown = false
      },
      // ---------- <<<<<<<<<<<<< 更新task ----------

      // ---------- 删除task >>>>>>>>>>>>> ----------
      async confirmDeleteItemDialog() {
        if (await window.confirmDialog({ title: "确认将任删除？" }) === false) {
          throw new Error("取消");
        }
      },
      async deleteTask() {
        const { id, ...data } = this.detail

        window.vtoast.loading("删除中");
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'allPage',
              actionId: 'deleteTask',
              where: { id }
            }
          }
        });
        window.vtoast.success("删除成功");

        this.$emit('save')
      },
      // ---------- <<<<<<<<<<<<< 删除task ----------
    }
  })
</script>
<style scoped>

</style>